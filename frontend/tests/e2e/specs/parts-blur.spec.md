# パーツ別シミュレーション結果のブラー表示 - E2Eテストシナリオ

**参照**: functional-spec.md セクション 3.4 (SCR-003) パーツ別適用モード
**関連E2E**: E2E-013 (パーツ別ブレンド生成・未認証・ブラー表示), E2E-014 (ブラー画像タップからログイン・結果閲覧)

---

## 概要

パーツ別シミュレーション機能において、未認証ユーザーには結果画像にブラーを適用し、認証を促すUX設計のテストシナリオ。

### 対象画面
- シミュレーション結果画面 (`/simulate/result`) - パーツ別適用モード

### テスト対象機能
1. 未認証ユーザーへのブラー表示
2. 認証済みユーザーへのクリア表示
3. ブラー画像タップによるログイン誘導
4. ログイン後のブラー解除

---

## 前提条件

- 利用規約に同意済み (`localStorage: cao_terms_agreed`)
- シミュレーション用画像がアップロード済み
- バックエンドAPIが動作している

---

## E2E-013: パーツ別ブレンド生成（未認証・ブラー表示）

### シナリオ1: 未認証ユーザーがパーツ別シミュレーションを実行し結果にブラーが適用される

**Given**:
- 未認証のユーザーがシミュレーション結果画面にいる
- パーツ別適用タブが選択されている
- パーツ（目、鼻など）が選択されている

**When**:
- ユーザーが「適用」ボタンをクリックしてパーツ別シミュレーションを実行する

**Then**:
- 結果画像にブラー効果が適用されて表示される
- 「タップしてログイン」というテキストがブラー画像上に表示される
- 画像の詳細は視認できない状態になっている

```gherkin
Scenario: 未認証ユーザーのパーツ別シミュレーション結果がブラー表示される
  Given 未認証ユーザーがシミュレーション結果画面にいる
  And パーツ別適用タブが選択されている
  And 目と鼻のパーツが選択されている
  When 適用ボタンをクリックする
  Then パーツ別シミュレーション結果が生成される
  And 結果画像にブラー効果が適用される
  And 「タップしてログイン」テキストが表示される
```

### シナリオ2: ブラー適用時でも元画像（現在の顔）は確認できる

**Given**:
- 未認証ユーザーがパーツ別シミュレーションを実行した後

**When**:
- 「現在」ボタンをクリックする

**Then**:
- 現在の顔画像がブラーなしで表示される
- 「適用後」ボタンをクリックするとブラー適用された結果画像に戻る

```gherkin
Scenario: 現在の顔画像はブラーなしで確認できる
  Given 未認証ユーザーがパーツ別シミュレーション結果を閲覧している
  And 結果画像にブラーが適用されている
  When 「現在」ボタンをクリックする
  Then 現在の顔画像がブラーなしで表示される
  When 「適用後」ボタンをクリックする
  Then ブラー適用された結果画像が表示される
```

---

## E2E-014: ブラー画像タップからログイン・結果閲覧

### シナリオ3: 未認証ユーザーがブラー画像をタップするとログイン誘導モーダルが表示される

**Given**:
- 未認証ユーザーがパーツ別シミュレーション結果画面にいる
- 結果画像にブラーが適用されている

**When**:
- ユーザーがブラー適用された画像をタップ（クリック）する

**Then**:
- パーツ別用ログイン誘導モーダルが表示される
- モーダルのタイトルは「パーツ別の結果を見るにはログインが必要です」
- モーダルの説明文は「パーツ別シミュレーションの詳細な結果を確認するにはログインしてください。」
- 「ログインする」ボタンが表示される
- 「今はログインしない」ボタンが表示される

```gherkin
Scenario: ブラー画像タップでログイン誘導モーダルが表示される
  Given 未認証ユーザーがパーツ別シミュレーション結果画面にいる
  And 結果画像にブラーが適用されている
  When ブラー画像をタップする
  Then パーツ別ログイン誘導モーダルが表示される
  And モーダルタイトルが「パーツ別の結果を見るにはログインが必要です」である
  And 「ログインする」ボタンが表示される
  And 「今はログインしない」ボタンが表示される
```

### シナリオ4: ログイン誘導モーダルの「ログインする」をクリックするとログイン画面に遷移する

**Given**:
- パーツ別ログイン誘導モーダルが表示されている

**When**:
- ユーザーが「ログインする」ボタンをクリックする

**Then**:
- ログイン画面（/login）に遷移する
- または、認証プロバイダーのログインフローが開始される

```gherkin
Scenario: ログインするボタンでログイン画面に遷移する
  Given パーツ別ログイン誘導モーダルが表示されている
  When 「ログインする」ボタンをクリックする
  Then ログイン画面に遷移する
```

### シナリオ5: ログイン誘導モーダルの「今はログインしない」をクリックするとモーダルが閉じる

**Given**:
- パーツ別ログイン誘導モーダルが表示されている

**When**:
- ユーザーが「今はログインしない」ボタンをクリックする

**Then**:
- モーダルが閉じる
- 結果画面に戻る（ブラー状態のまま）

```gherkin
Scenario: 今はログインしないボタンでモーダルが閉じる
  Given パーツ別ログイン誘導モーダルが表示されている
  When 「今はログインしない」ボタンをクリックする
  Then モーダルが閉じる
  And 結果画面に戻る
  And ブラー画像が引き続き表示される
```

### シナリオ6: ログイン後、パーツ別シミュレーション結果がブラーなしで表示される

**Given**:
- 未認証ユーザーがパーツ別シミュレーションを実行済み
- 結果がブラー表示されている
- ユーザーがログイン誘導モーダルから「ログインする」をクリックした

**When**:
- ユーザーがログインを完了する
- シミュレーション結果画面に戻る（リダイレクト）

**Then**:
- パーツ別シミュレーション結果がブラーなしで表示される
- 画像の詳細が確認できる状態になっている
- 「タップしてログイン」テキストは表示されない

```gherkin
Scenario: ログイン後はブラーなしで結果が表示される
  Given 未認証ユーザーがパーツ別シミュレーション結果をブラー表示で閲覧している
  And ブラー画像をタップしてログイン誘導モーダルを表示している
  When 「ログインする」ボタンをクリックする
  And ログインを完了する
  Then シミュレーション結果画面にリダイレクトされる
  And パーツ別シミュレーション結果がブラーなしで表示される
  And 「タップしてログイン」テキストが表示されない
```

---

## 認証済みユーザーのフロー

### シナリオ7: 認証済みユーザーがパーツ別シミュレーションを実行すると結果がブラーなしで表示される

**Given**:
- 認証済みのユーザーがシミュレーション結果画面にいる
- パーツ別適用タブが選択されている

**When**:
- パーツを選択して「適用」ボタンをクリックする

**Then**:
- パーツ別シミュレーション結果がブラーなしで表示される
- 「タップしてログイン」テキストは表示されない
- 画像の詳細が確認できる

```gherkin
Scenario: 認証済みユーザーの結果はブラーなしで表示される
  Given 認証済みユーザーがシミュレーション結果画面にいる
  And パーツ別適用タブが選択されている
  When パーツを選択して適用ボタンをクリックする
  Then パーツ別シミュレーション結果がブラーなしで表示される
  And 「タップしてログイン」テキストが表示されない
```

---

## アクセシビリティテスト

### シナリオ8: ブラー画像がキーボード操作でフォーカス・実行可能

**Given**:
- 未認証ユーザーがパーツ別シミュレーション結果画面にいる
- 結果画像にブラーが適用されている

**When**:
- Tabキーでブラー画像にフォーカスする

**Then**:
- フォーカスリングが表示される
- Enterキーを押すとログイン誘導モーダルが表示される
- スペースキーを押してもログイン誘導モーダルが表示される

```gherkin
Scenario: ブラー画像はキーボードでアクセス可能
  Given 未認証ユーザーがパーツ別シミュレーション結果画面にいる
  When Tabキーでブラー画像にフォーカスする
  Then フォーカスリングが表示される
  When Enterキーを押す
  Then ログイン誘導モーダルが表示される
```

### シナリオ9: スクリーンリーダー用のaria属性が適切に設定されている

**Given**:
- 未認証ユーザーがパーツ別シミュレーション結果画面にいる

**When**:
- スクリーンリーダーでブラー画像を読み上げる

**Then**:
- 「ログインしてパーツ別シミュレーション結果を表示」という読み上げがされる
- role="button"が設定されている

```gherkin
Scenario: スクリーンリーダーでアクセス可能
  Given 未認証ユーザーがパーツ別シミュレーション結果画面にいる
  When スクリーンリーダーでブラー画像を読み上げる
  Then aria-label「ログインしてパーツ別シミュレーション結果を表示」が読み上げられる
```

---

## エッジケース

### シナリオ10: ログインセッションが途中で切れた場合

**Given**:
- 認証済みユーザーがパーツ別シミュレーション結果を閲覧中
- セッションが期限切れになる

**When**:
- ページをリロードする

**Then**:
- 未認証状態として検出される
- 結果画像にブラーが適用される

```gherkin
Scenario: セッション切れでブラーが再適用される
  Given 認証済みユーザーがパーツ別シミュレーション結果を閲覧中
  And セッションが期限切れになる
  When ページをリロードする
  Then 結果画像にブラーが適用される
```

### シナリオ11: パーツ別結果画像のローディング中の表示

**Given**:
- ユーザーがパーツ別シミュレーションを実行した

**When**:
- 結果画像がロード中

**Then**:
- スケルトン（プレースホルダー）が表示される
- ブラーは画像がロードされた後に適用される

```gherkin
Scenario: ローディング中はスケルトンが表示される
  Given ユーザーがパーツ別シミュレーションを実行した
  When 結果画像がロード中
  Then スケルトンが表示される
  And 画像ロード完了後にブラーが適用される（未認証の場合）
```

---

## テストデータ

### 画像データ
- 有効な顔画像: `/tests/e2e/fixtures/valid-face.jpg`
- 理想の顔画像: `/tests/e2e/fixtures/ideal-face.jpg`

### 認証情報
- テストユーザー: 環境変数で設定
- 認証状態のモック: localStorageまたはClerkのテストモード使用

---

## 関連するdata-testid

| 要素 | data-testid |
|------|-------------|
| パーツ別タブ | `parts-tab` |
| パーツ選択ボタン（目） | `parts-selector-eye` |
| パーツ選択ボタン（鼻） | `parts-selector-nose` |
| 適用ボタン | `apply-parts-button` |
| ブラーオーバーレイ | `parts-blur-overlay` |
| ブラーエフェクト要素 | `parts-blur-overlay-blur` |
| 画像コンテナ | `parts-blur-overlay-image-container` |
| タップしてログインテキスト | `parts-blur-login-text` |
| パーツ別ログイン誘導モーダル | `parts-login-prompt-modal` |
| モーダルログインボタン | `parts-login-prompt-modal-login-button` |
| モーダルキャンセルボタン | `parts-login-prompt-modal-cancel-button` |
| 現在ボタン | `toggle-current-button` |
| 適用後ボタン | `toggle-applied-button` |

---

## 実装メモ

### ブラー効果のCSS
```css
.blur-lg {
  filter: blur(16px);
}
```

### 認証状態の取得
```typescript
// useClerkSafe.ts
const { isSignedIn } = useUserSafe()
```

### sessionStorage/localStorageの利用
- シミュレーション結果画像: `sessionStorage: cao_parts_result_image`
- ログイン後のリダイレクト先: `sessionStorage: cao_redirect_after_login`
