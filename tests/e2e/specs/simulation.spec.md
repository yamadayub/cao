# E2Eテストシナリオ: シミュレーション生成・確認 (UC-004, UC-005)

## 概要
モーフィングシミュレーション生成および結果確認に関するE2Eテストシナリオ

---

## シナリオ1: シミュレーション生成の正常フロー

### 前提条件
- 利用規約に同意済み
- 現在の顔画像と理想の顔画像がアップロード済み

### テストステップ（Given/When/Then）

**Given（前提）:**
- 両方の画像がアップロードされている
- 「シミュレーションを生成」ボタンが活性化されている

**When（操作）:**
1. 「シミュレーションを生成」ボタンをクリックする

**Then（期待結果）:**
- ローディング表示が開始される
- ボタンが非活性化される（二重送信防止）
- 処理完了後、結果画面（/simulate/result）に遷移する
- 段階的モーフィング画像（5段階）が生成される

---

## シナリオ2: 結果画面でのスライダー操作

### 前提条件
- シミュレーション生成が完了
- 結果画面が表示されている

### テストステップ（Given/When/Then）

**Given（前提）:**
- シミュレーション結果画面が表示されている
- デフォルトで50%の変化度合いの画像が表示されている

**When（操作）:**
1. スライダーを左端（0%）にドラッグする

**Then（期待結果）:**
- 0%（現在の顔そのまま）の画像が表示される
- 「現在の変化度: 0%」と表示される

---

## シナリオ3: スライダーで各段階を確認

### 前提条件
- シミュレーション結果画面が表示されている

### テストステップ（Given/When/Then）

**Given（前提）:**
- シミュレーション結果画面が表示されている

**When（操作）:**
1. スライダーを0%の位置に移動する
2. スライダーを25%の位置に移動する
3. スライダーを50%の位置に移動する
4. スライダーを75%の位置に移動する
5. スライダーを100%の位置に移動する

**Then（期待結果）:**
- 各段階で対応する変化度合いの画像が表示される
- 0%: 現在の顔そのまま
- 25%: 現在の顔寄り
- 50%: 中間
- 75%: 理想の顔寄り
- 100%: 理想の顔そのまま
- 画像の切り替えがスムーズに行われる

---

## シナリオ4: 結果画面から新規シミュレーション作成

### 前提条件
- シミュレーション結果画面が表示されている

### テストステップ（Given/When/Then）

**Given（前提）:**
- シミュレーション結果画面が表示されている

**When（操作）:**
1. 「新しいシミュレーションを作成」ボタンをクリックする

**Then（期待結果）:**
- シミュレーション作成画面（/simulate）に遷移する
- 画像アップロードエリアが初期状態である
- 前回のシミュレーション結果は保持されない（未認証の場合）

---

## シナリオ5: 生成中のキャンセル（ページ離脱）

### 前提条件
- シミュレーション生成処理中

### テストステップ（Given/When/Then）

**Given（前提）:**
- 「シミュレーションを生成」をクリックし、ローディング中

**When（操作）:**
1. ブラウザの戻るボタンをクリックする、または別のページに遷移しようとする

**Then（期待結果）:**
- 確認ダイアログが表示される（「処理中です。ページを離れますか？」）
- 「キャンセル」を選択すると処理を継続
- 「離れる」を選択するとシミュレーション作成画面に戻る

---

## エラーケース

### E1: API通信エラー

**Given（前提）:**
- 両方の画像がアップロードされている
- ネットワーク接続が不安定

**When（操作）:**
1. 「シミュレーションを生成」ボタンをクリックする
2. 通信エラーが発生する

**Then（期待結果）:**
- エラーメッセージ「通信エラーが発生しました。再度お試しください」がトースト通知で表示される
- 「シミュレーションを生成」ボタンが再度活性化される
- アップロード済みの画像は保持される

---

### E2: 処理タイムアウト

**Given（前提）:**
- 両方の画像がアップロードされている
- サーバーの処理が遅延している

**When（操作）:**
1. 「シミュレーションを生成」ボタンをクリックする
2. 処理が一定時間（30秒など）を超える

**Then（期待結果）:**
- エラーメッセージ「処理がタイムアウトしました。画像を変更してお試しください」が表示される
- 「シミュレーションを生成」ボタンが再度活性化される

---

### E3: サーバー内部エラー

**Given（前提）:**
- 両方の画像がアップロードされている

**When（操作）:**
1. 「シミュレーションを生成」ボタンをクリックする
2. サーバーが500エラーを返す

**Then（期待結果）:**
- エラーメッセージ「処理中にエラーが発生しました。再度お試しください」が表示される
- 「シミュレーションを生成」ボタンが再度活性化される
- リトライが可能

---

### E4: レート制限超過

**Given（前提）:**
- 未認証ユーザー
- 短時間に複数回シミュレーションを生成

**When（操作）:**
1. 11回目のシミュレーション生成を試みる（10回/分の制限超過）

**Then（期待結果）:**
- エラーメッセージ「リクエストが多すぎます。しばらく待ってから再度お試しください」が表示される
- 一定時間後に再試行可能

---

## シナリオ6: 未認証ユーザーの保存ボタンクリック

### 前提条件
- シミュレーション結果画面が表示されている
- ユーザーは未認証

### テストステップ（Given/When/Then）

**Given（前提）:**
- シミュレーション結果が表示されている
- ユーザーはログインしていない

**When（操作）:**
1. 「保存」ボタンをクリックする

**Then（期待結果）:**
- ログイン誘導モーダルが表示される
- 「保存するにはログインが必要です」というメッセージが表示される
- 「ログインする」ボタンと「今はログインしない」リンクが表示される

---

## シナリオ7: 未認証ユーザーの共有URLボタンクリック

### 前提条件
- シミュレーション結果画面が表示されている
- ユーザーは未認証

### テストステップ（Given/When/Then）

**Given（前提）:**
- シミュレーション結果が表示されている
- ユーザーはログインしていない

**When（操作）:**
1. 「共有URL」ボタンをクリックする

**Then（期待結果）:**
- ログイン誘導モーダルが表示される
- 「共有するにはログインが必要です」または同様のメッセージが表示される

---

## テストデータ

| データ | 説明 |
|--------|------|
| current_face.jpg | 現在の顔画像（正常） |
| ideal_face.jpg | 理想の顔画像（正常） |

## 関連ユースケース
- UC-004: モーフィングシミュレーションを生成
- UC-005: シミュレーション結果をスライダーで確認

## 関連画面
- SCR-002: シミュレーション作成画面
- SCR-003: シミュレーション結果画面

## API参照
- POST /api/v1/morph/stages - 段階的モーフィング
