# E2Eテストシナリオ: 保存・共有 (UC-006, UC-007, UC-008)

## 概要
シミュレーション結果の保存、共有URL生成、共有閲覧に関するE2Eテストシナリオ

---

## シナリオ1: シミュレーション結果の保存（認証済みユーザー）

### 前提条件
- ユーザーはログイン済み
- シミュレーション生成が完了し、結果画面が表示されている

### テストステップ（Given/When/Then）

**Given（前提）:**
- シミュレーション結果画面が表示されている
- ユーザーはログイン済み

**When（操作）:**
1. 「保存」ボタンをクリックする

**Then（期待結果）:**
- ローディング表示が表示される
- 保存完了メッセージ「シミュレーションを保存しました」が表示される
- マイページで保存済みシミュレーション一覧に追加される

---

## シナリオ2: 共有URLの生成

### 前提条件
- ユーザーはログイン済み
- シミュレーションが保存済み

### テストステップ（Given/When/Then）

**Given（前提）:**
- シミュレーション結果画面が表示されている
- シミュレーションが保存済み

**When（操作）:**
1. 「共有URL」ボタンをクリックする

**Then（期待結果）:**
- 共有URLコピーモーダルが表示される
- 共有URL（例: `https://cao.app/s/abc123xyz`）が表示される
- 「URLをコピー」ボタンが表示される
- 「閉じる」ボタンが表示される

---

## シナリオ3: 共有URLのコピー

### 前提条件
- 共有URLコピーモーダルが表示されている

### テストステップ（Given/When/Then）

**Given（前提）:**
- 共有URLコピーモーダルが表示されている
- 共有URLが表示されている

**When（操作）:**
1. 「URLをコピー」ボタンをクリックする

**Then（期待結果）:**
- クリップボードに共有URLがコピーされる
- 「コピーしました」というフィードバックが表示される
- モーダルは開いたままで、ユーザーが「閉じる」をクリックして閉じられる

---

## シナリオ4: 未保存時の共有URL生成（自動保存）

### 前提条件
- ユーザーはログイン済み
- シミュレーション結果画面が表示されているが、まだ保存していない

### テストステップ（Given/When/Then）

**Given（前提）:**
- シミュレーション結果画面が表示されている
- シミュレーションは未保存状態

**When（操作）:**
1. 「共有URL」ボタンをクリックする

**Then（期待結果）:**
- 自動的にシミュレーションが保存される
- 共有URLが生成される
- 共有URLコピーモーダルが表示される

---

## シナリオ5: 共有URLからシミュレーション結果を閲覧

### 前提条件
- 有効な共有URLを持っている

### テストステップ（Given/When/Then）

**Given（前提）:**
- 共有URL（例: `https://cao.app/s/abc123xyz`）を持っている
- 閲覧者は未認証でも認証済みでも可

**When（操作）:**
1. 共有URLにアクセスする

**Then（期待結果）:**
- 共有閲覧画面（/s/{token}）が表示される
- シミュレーション結果画像が表示される
- スライダーで変化度合いを確認できる
- 「自分もシミュレーションを試す」ボタンが表示される
- 保存・編集機能は表示されない（閲覧専用）

---

## シナリオ6: 共有閲覧画面でのスライダー操作

### 前提条件
- 共有閲覧画面が表示されている

### テストステップ（Given/When/Then）

**Given（前提）:**
- 共有閲覧画面が表示されている

**When（操作）:**
1. スライダーを0%の位置に移動する
2. スライダーを100%の位置に移動する

**Then（期待結果）:**
- 各段階の変化度合い画像が表示される
- 画像が正しく切り替わる

---

## シナリオ7: 共有閲覧画面から自分のシミュレーションを開始

### 前提条件
- 共有閲覧画面が表示されている

### テストステップ（Given/When/Then）

**Given（前提）:**
- 共有閲覧画面が表示されている

**When（操作）:**
1. 「自分もシミュレーションを試す」ボタンをクリックする

**Then（期待結果）:**
- シミュレーション作成画面（/simulate）に遷移する
- 新規のシミュレーション作成が可能な状態

---

## シナリオ8: マイページから共有URL生成

### 前提条件
- ユーザーはログイン済み
- 保存済みシミュレーションがある

### テストステップ（Given/When/Then）

**Given（前提）:**
- マイページが表示されている
- 保存済みシミュレーションのサムネイルが表示されている

**When（操作）:**
1. シミュレーションカードの「共有」ボタンをクリックする

**Then（期待結果）:**
- 共有URLコピーモーダルが表示される
- 共有URLが表示される

---

## エラーケース

### E1: 無効な共有URLへのアクセス

**Given（前提）:**
- 無効な共有URL（存在しないトークン）を持っている

**When（操作）:**
1. 無効な共有URL（例: `https://cao.app/s/invalid-token`）にアクセスする

**Then（期待結果）:**
- エラー画面が表示される
- 「このURLは無効または期限切れです」というメッセージが表示される
- 「トップページへ戻る」ボタンが表示される

---

### E2: 削除されたシミュレーションの共有URLへのアクセス

**Given（前提）:**
- 以前有効だった共有URLがあるが、元のシミュレーションは削除されている

**When（操作）:**
1. その共有URLにアクセスする

**Then（期待結果）:**
- エラー画面が表示される
- 「このシミュレーションは削除されました」または「URLは無効です」と表示される

---

### E3: 保存時のサーバーエラー

**Given（前提）:**
- ユーザーはログイン済み
- シミュレーション結果画面が表示されている

**When（操作）:**
1. 「保存」ボタンをクリックする
2. サーバーが500エラーを返す

**Then（期待結果）:**
- エラーメッセージ「保存に失敗しました。再度お試しください」が表示される
- 「保存」ボタンが再度クリック可能になる

---

### E4: 共有URL生成時のサーバーエラー

**Given（前提）:**
- ユーザーはログイン済み
- シミュレーションが保存済み

**When（操作）:**
1. 「共有URL」ボタンをクリックする
2. サーバーが500エラーを返す

**Then（期待結果）:**
- エラーメッセージ「共有URLの生成に失敗しました。再度お試しください」が表示される

---

### E5: セッション切れ時の保存試行

**Given（前提）:**
- ユーザーはログイン済みだったが、セッションが期限切れ

**When（操作）:**
1. 「保存」ボタンをクリックする

**Then（期待結果）:**
- 認証エラーが検出される
- ログイン誘導モーダルが表示される、またはログイン画面にリダイレクトされる

---

## テストデータ

| データ | 説明 |
|--------|------|
| valid_share_token | 有効な共有トークン |
| invalid_token | 存在しない共有トークン |
| deleted_sim_token | 削除済みシミュレーションのトークン |

## 関連ユースケース
- UC-006: シミュレーション結果を保存
- UC-007: 共有URLを生成
- UC-008: 共有URLからシミュレーション結果を閲覧

## 関連画面
- SCR-003: シミュレーション結果画面
- SCR-004: 共有閲覧画面
- SCR-006: マイページ

## API参照
- POST /api/v1/simulations - シミュレーション保存
- POST /api/v1/simulations/{id}/share - 共有URL生成
- GET /api/v1/shared/{token} - 共有シミュレーション取得
