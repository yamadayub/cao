# E2Eテストシナリオ: ユーザー登録・ログイン (UC-009)

## 概要
ユーザー認証（メールマジックリンク、Googleログイン）に関するE2Eテストシナリオ

---

## シナリオ1: ログイン画面への遷移

### 前提条件
- ユーザーは未認証

### テストステップ（Given/When/Then）

**Given（前提）:**
- ユーザーがトップページ（/）または任意のページにアクセスしている
- ヘッダーに「ログイン」ボタンが表示されている

**When（操作）:**
1. ヘッダーの「ログイン」ボタンをクリックする

**Then（期待結果）:**
- ログイン画面（/login）に遷移する
- メールアドレス入力フォームが表示される
- 「マジックリンクを送信」ボタンが表示される
- 「Googleでログイン」ボタンが表示される

---

## シナリオ2: メールマジックリンクでの新規登録・ログイン

### 前提条件
- ユーザーは未認証
- ログイン画面が表示されている

### テストステップ（Given/When/Then）

**Given（前提）:**
- ログイン画面が表示されている
- メールアドレス入力欄が空

**When（操作）:**
1. メールアドレス入力欄に有効なメールアドレスを入力する
2. 「マジックリンクを送信」ボタンをクリックする

**Then（期待結果）:**
- ローディング表示が開始される
- 「メールを送信しました」画面に遷移する
- 入力したメールアドレス宛にログインリンクを送信した旨が表示される
- 「再送信」リンクが表示される

---

## シナリオ3: マジックリンクからのログイン完了

### 前提条件
- マジックリンクメールを受信済み

### テストステップ（Given/When/Then）

**Given（前提）:**
- メールに記載されたマジックリンクを取得している

**When（操作）:**
1. メール内のログインリンクをクリックする

**Then（期待結果）:**
- 自動的にログイン処理が行われる
- マイページ（/mypage）にリダイレクトされる
- ヘッダーに「ログイン」ボタンの代わりに「マイページ」リンクが表示される
- ユーザーのメールアドレスがマイページに表示される

---

## シナリオ4: シミュレーション後のログインからの復帰

### 前提条件
- シミュレーション結果画面で「保存」をクリックし、ログイン誘導モーダルが表示されている

### テストステップ（Given/When/Then）

**Given（前提）:**
- シミュレーション結果が表示されている
- ログイン誘導モーダルが表示されている

**When（操作）:**
1. 「ログインする」ボタンをクリックする
2. ログイン画面でメールアドレスを入力し、マジックリンクを送信する
3. メール内のリンクをクリックしてログインする

**Then（期待結果）:**
- ログイン後、シミュレーション結果画面（/simulate/result）にリダイレクトされる
- シミュレーション結果が保持されている
- 「保存」ボタンが機能する状態になっている

---

## シナリオ5: Googleログイン

### 前提条件
- ユーザーは未認証
- ログイン画面が表示されている

### テストステップ（Given/When/Then）

**Given（前提）:**
- ログイン画面が表示されている

**When（操作）:**
1. 「Googleでログイン」ボタンをクリックする
2. Googleの認証画面でアカウントを選択または認証情報を入力する
3. アクセスを許可する

**Then（期待結果）:**
- Googleの認証画面にリダイレクトされる
- 認証成功後、マイページ（/mypage）にリダイレクトされる
- Googleアカウントのメールアドレスがマイページに表示される

---

## シナリオ6: ログアウト

### 前提条件
- ユーザーはログイン済み

### テストステップ（Given/When/Then）

**Given（前提）:**
- ユーザーがログインしてマイページを開いている

**When（操作）:**
1. ヘッダーまたはマイページの「ログアウト」ボタンをクリックする

**Then（期待結果）:**
- ログアウト処理が行われる
- トップページ（/）にリダイレクトされる
- ヘッダーに「ログイン」ボタンが再表示される
- マイページにアクセスすると、ログイン画面にリダイレクトされる

---

## シナリオ7: 認証が必要なページへの未認証アクセス

### 前提条件
- ユーザーは未認証

### テストステップ（Given/When/Then）

**Given（前提）:**
- ユーザーはログインしていない

**When（操作）:**
1. 直接マイページ（/mypage）のURLにアクセスする

**Then（期待結果）:**
- ログイン画面（/login）にリダイレクトされる
- ログイン後にマイページに戻る導線がある

---

## エラーケース

### E1: 無効なメールアドレス形式

**Given（前提）:**
- ログイン画面が表示されている

**When（操作）:**
1. メールアドレス欄に「invalid-email」と入力する
2. 「マジックリンクを送信」ボタンをクリックする

**Then（期待結果）:**
- エラーメッセージ「有効なメールアドレスを入力してください」が表示される
- メール送信は行われない

---

### E2: 空のメールアドレス

**Given（前提）:**
- ログイン画面が表示されている

**When（操作）:**
1. メールアドレス欄を空のままにする
2. 「マジックリンクを送信」ボタンをクリックする

**Then（期待結果）:**
- エラーメッセージ「メールアドレスを入力してください」が表示される
- メール送信は行われない

---

### E3: 期限切れのマジックリンク

**Given（前提）:**
- 過去に受信したマジックリンク（有効期限切れ）がある

**When（操作）:**
1. 期限切れのマジックリンクをクリックする

**Then（期待結果）:**
- エラーメッセージ「このリンクは無効または期限切れです」が表示される
- ログイン画面へのリンクが表示される

---

### E4: Googleログインのキャンセル

**Given（前提）:**
- ログイン画面が表示されている

**When（操作）:**
1. 「Googleでログイン」ボタンをクリックする
2. Googleの認証画面で「キャンセル」または拒否する

**Then（期待結果）:**
- ログイン画面に戻る
- エラーメッセージ「ログインがキャンセルされました」が表示される、または何も表示されずに元の画面に戻る

---

### E5: マジックリンクの再送信

**Given（前提）:**
- 「メールを送信しました」画面が表示されている

**When（操作）:**
1. 「再送信」リンクをクリックする

**Then（期待結果）:**
- マジックリンクが再送信される
- 「メールを再送信しました」というメッセージが表示される
- 過度な再送信を防ぐため、一定時間のクールダウンがある可能性

---

## テストデータ

| データ | 説明 |
|--------|------|
| test@example.com | テスト用メールアドレス |
| invalid-email | 無効なメールアドレス形式 |
| (Google Test Account) | Googleログイン用テストアカウント |

## 関連ユースケース
- UC-009: ユーザー登録・ログイン

## 関連画面
- SCR-005: ログイン画面
- SCR-006: マイページ

## セキュリティ要件参照
- SEC-AUTH-001: パスワードレス認証（Magic Link）
- SEC-AUTH-002: OAuth認証（Google）
- SEC-AUTH-003: セッション管理（JWT、有効期限7日）
